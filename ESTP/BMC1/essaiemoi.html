<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D1 Viewer (via Cloudflare Worker)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    input, button { padding: 8px 12px; font-size: 16px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { position: sticky; top: 0; background: #f6f6f6; }
    .muted { color: #666; font-size: 14px; }
    .error { color: #b00020; }
    .ok { color: #0a7a0a; }
    pre { background: #f7f7f7; padding: 12px; overflow: auto; }
  </style>
</head>
<body>
  <h1>D1 Viewer</h1>
  <p class="muted">
    Cette page appelle ton <strong>Worker Cloudflare</strong> (qui parle Ã  D1 avec ton secret cÃ´tÃ© serveur). Aucun secret nâ€™est exposÃ© ici.
  </p>

  <div class="row">
    <label for="apiBase">URL du Worker :</label>
    <input id="apiBase" type="url" size="50" placeholder="https://ton-worker.workers.dev" />
  </div>

  <div class="row">
    <label for="tableName">Nom de la table :</label>
    <input id="tableName" type="text" size="24" placeholder="ma_table" />
    <button id="btnLoad">Charger</button>
  </div>

  <div id="status" class="muted">PrÃªt.</div>

  <div id="result"></div>

  <script>
    // ðŸ‘‰ Adapte ce chemin si ton Worker expose un autre endpoint que /rest/{table}
    function buildUrl(base, table) {
      base = base.replace(/\/+$/, "");
      return `${base}/rest/${encodeURIComponent(table)}`;
    }

    async function fetchRows() {
      const base = document.getElementById("apiBase").value.trim();
      const table = document.getElementById("tableName").value.trim();
      const status = document.getElementById("status");
      const result = document.getElementById("result");
      result.innerHTML = "";

      if (!base || !table) {
        status.innerHTML = '<span class="error">Renseigne lâ€™URL du Worker et le nom de la table.</span>';
        return;
      }

      status.textContent = "Chargement...";
      try {
        // Aucun Authorization ici : le Worker ajoute le Bearer cÃ´tÃ© serveur et gÃ¨re CORS.
        const res = await fetch(buildUrl(base, table), { method: "GET" });
        const text = await res.text();

        let data;
        try {
          data = JSON.parse(text);
        } catch {
          // Si ce nâ€™est pas du JSON valide, on lâ€™affiche brut pour diagnostiquer
          result.innerHTML = "<h3>RÃ©ponse brute</h3><pre></pre>";
          result.querySelector("pre").textContent = text;
          status.innerHTML = res.ok
            ? '<span class="ok">RÃ©ponse reÃ§ue (non-JSON).</span>'
            : `<span class="error">Erreur HTTP ${res.status}</span>`;
          return;
        }

        // On accepte soit { rows: [...] } soit directement [...]
        const rows = Array.isArray(data) ? data : (data.rows || data.result || []);
        if (!Array.isArray(rows) || rows.length === 0) {
          status.innerHTML = '<span class="ok">Aucune ligne trouvÃ©e.</span>';
          result.innerHTML = "<p class='muted'>La table est vide ou le format nâ€™est pas reconnu.</p>";
          return;
        }

        // Colonnes dynamiques (union des clÃ©s)
        const cols = Array.from(
          rows.reduce((set, row) => {
            Object.keys(row || {}).forEach(k => set.add(k));
            return set;
          }, new Set())
        );

        // GÃ©nÃ¨re la table HTML
        const tableEl = document.createElement("table");
        const thead = document.createElement("thead");
        const trHead = document.createElement("tr");
        cols.forEach(c => {
          const th = document.createElement("th");
          th.textContent = c;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        tableEl.appendChild(thead);

        const tbody = document.createElement("tbody");
        rows.forEach(row => {
          const tr = document.createElement("tr");
          cols.forEach(c => {
            const td = document.createElement("td");
            const v = row?.[c];
            td.textContent = typeof v === "object" ? JSON.stringify(v) : String(v ?? "");
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        tableEl.appendChild(tbody);

        result.appendChild(tableEl);
        status.innerHTML = '<span class="ok">TerminÃ©.</span>';
      } catch (err) {
        console.error(err);
        status.innerHTML = `<span class="error">Erreur : ${err?.message || err}</span>`;
      }
    }

    document.getElementById("btnLoad").addEventListener("click", fetchRows);

    // Optionnel : valeurs par dÃ©faut pour aller plus vite en dev
    // document.getElementById("apiBase").value = "https://ton-worker.workers.dev";
    // document.getElementById("tableName").value = "ma_table";
  </script>
</body>
</html>
